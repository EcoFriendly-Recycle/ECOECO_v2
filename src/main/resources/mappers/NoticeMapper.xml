<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.recycle.ecoeco.manager.board.model.dao.NoticeMapper">

    <resultMap type="com.recycle.ecoeco.manager.board.model.dto.NoticeDTO" id="noticeResultMap" >
        <id property="noticeNo" column="noticeNo"/>
<!--        <result property="noticeCategory" column="noticeCategory"/>-->
        <association property="writer" resultMap="userResultMap"/>
    </resultMap>

    <resultMap type="com.recycle.ecoeco.user.mypage.model.dto.UserInfoDTO" id="userResultMap" >
        <id property="userNo" column="userNo"/>
    </resultMap>

    <!-- 공지사항 조회 리스트 카운트 -->
    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
        COUNT(*)
        FROM
        NOTICE b
<!--        <if test="searchCondition == 'writer'">-->
<!--            JOIN-->
<!--            USER_INFO u ON(b.userNo = u.userNo)-->
<!--        </if>-->
        <where>
            <if test="searchCondition == 'noticeCategory'">
                b.noticeCategory = #{ searchValue }
            </if>
            AND
            b.noticeStatus = 'Y'
        </where>
    </select>

    <!-- 공지사항 전체 목록 조회 -->
    <select id="selectNoticeList" resultMap="noticeResultMap">
        SELECT
            b.noticeNo,
            b.noticeCategory,
            b.noticeTitle,
            b.noticeDate,
            u.userName
        FROM
            NOTICE b
        JOIN
            USER_INFO u ON (b.userNo = u.userNo)
        <where>
            <if test="searchCondition == 'writer'">
                u.userName LIKE CONCAT('%', #{ searchValue }, '%')
            </if>
            <if test="searchCondition == 'title'">
                b.noticeTitle LIKE CONCAT('%', #{ searchValue }, '%')
            </if>
            AND
            b.noticeStatus = 'Y'
        </where>
        ORDER BY
        b.noticeNo DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 공지사항 상세 조회 -->
    <select id="selectNoticeDetail" resultMap="noticeResultMap">
        SELECT
            b.noticeNo,
            b.noticeCategory,
            b.noticeSubCategory,
            b.noticeTitle,
            b.noticeDate,
            b.noticeDetail,
            u.userName
        FROM
            NOTICE b
        JOIN
            USER_INFO u ON (b.userNo = u.userNo)
        WHERE
            b.noticeNo = #{noticeNo}
    </select>

    <insert id="insertNotice">
        INSERT INTO NOTICE
                    (noticeCategory, noticeSubCategory, noticeTitle, noticeDetail, noticeDate, userNo)
        VALUES
        (#{ noticeCategory }, #{ noticeSubCategory }, #{ noticeTitle }, #{ noticeDetail }, current_date(), #{ writer.userNo })
        <selectKey keyProperty="noticeNo" order="AFTER" resultType="int">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="deleteNotice">
        UPDATE
        Notice
        SET
        noticeStatus = 'N'
        WHERE
        noticeNo = #{ noticeNo }
    </update>

</mapper>

